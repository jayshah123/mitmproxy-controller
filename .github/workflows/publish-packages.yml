name: publish-packages

on:
  release:
    types: [published, released]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (for manual runs), e.g. v1.2.3"
        required: false
        type: string

permissions:
  contents: read

jobs:
  resolve-tag:
    name: Resolve release tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Resolve tag
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "release" ]; then
            tag="${{ github.event.release.tag_name }}"
          else
            tag="${{ inputs.release_tag }}"
          fi

          if [ -z "$tag" ]; then
            echo "release_tag input is required for workflow_dispatch" >&2
            exit 1
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"

  homebrew:
    name: Update Homebrew Formula
    needs: [resolve-tag]
    if: ${{ !contains(needs.resolve-tag.outputs.tag, '-') }}
    runs-on: ubuntu-latest
    env:
      COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
    steps:
      - name: Skip when token is missing
        if: env.COMMITTER_TOKEN == ''
        run: echo "HOMEBREW_TAP_TOKEN is not configured; skipping Homebrew publish."

      - name: Bump Homebrew formula
        if: env.COMMITTER_TOKEN != ''
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: mitmproxy-controller
          homebrew-tap: jayshah123/homebrew-tap
          tag-name: ${{ needs.resolve-tag.outputs.tag }}
          download-url: https://github.com/${{ github.repository }}/releases/download/${{ needs.resolve-tag.outputs.tag }}/mitmproxy-controller_darwin_arm64.tar.gz

  winget:
    name: Update Winget Manifest
    needs: [resolve-tag]
    if: ${{ !contains(needs.resolve-tag.outputs.tag, '-') }}
    runs-on: windows-latest
    env:
      WINGET_TOKEN: ${{ secrets.WINGET_TOKEN }}
    steps:
      - name: Skip when token is missing
        if: env.WINGET_TOKEN == ''
        shell: pwsh
        run: Write-Host "WINGET_TOKEN is not configured; skipping Winget publish."

      - name: Check package bootstrap in winget-pkgs
        if: env.WINGET_TOKEN != ''
        id: winget-bootstrap
        shell: pwsh
        run: |
          $pkgUrl = "https://github.com/microsoft/winget-pkgs/tree/master/manifests/j/Jayshah123/MitmproxyController"
          try {
            Invoke-WebRequest -Uri $pkgUrl -Method Head -ErrorAction Stop | Out-Null
            "exists=true" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Host "Package is not yet bootstrapped in winget-pkgs; skipping automated update."
            "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Skip when package is not bootstrapped
        if: env.WINGET_TOKEN != '' && steps.winget-bootstrap.outputs.exists != 'true'
        shell: pwsh
        run: Write-Host "Skipped Winget publish because initial package submission is not present."

      - name: Submit Winget manifest update
        if: env.WINGET_TOKEN != '' && steps.winget-bootstrap.outputs.exists == 'true'
        uses: vedantmgoyal9/winget-releaser@v2
        with:
          identifier: Jayshah123.MitmproxyController
          release-tag: ${{ needs.resolve-tag.outputs.tag }}
          installers-regex: mitmproxy-controller_windows_amd64\\.zip$
          token: ${{ env.WINGET_TOKEN }}
